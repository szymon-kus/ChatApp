@{
ViewData["Title"] = "Chat";
var loggedInUser = ViewBag.LoggedInUser;
var messages = ViewBag.Messages;
}

<head>
    <link rel="stylesheet" href="~/css/Chat.css" />
    <title>Chat Application</title>
</head>
<body>
<main>
    <div id="chatContainer">
        <div id="user-list">
            <h2 id="friendsText">Users</h2>
            <ul id="userList">
                @foreach (var user in ViewBag.Users)
                {
                <li onclick="setReceiver('@user.Username')">
                    <span class="status-indicator @((user.Username == loggedInUser) ? "online" : "offline")"></span>
                    @user.Username
                </li>
                }
            </ul>
        </div>
        <div class="chat-window">
            <div id="upperNameField">
                <div id="usernameContainer">
                    <p id="usernameText">Username</p>
                </div>
                <div id="usernameTextContainer">
                    <p id="websiteName">ChatGpt</p>
                </div>
            </div>
            <div id="chatMessagesContainer">
                @if (messages != null)
                {
                @foreach (var message in messages)
                {
                <div class="chatMessage">
                    <strong>@message.Sender:</strong> @message.Content
                </div>
                }
                }
            </div>
            <div id="chatInput">
                <input type="hidden" id="loggedInUser" value="@loggedInUser" />
                <input type="hidden" id="receiver" value="" />
                <input type="text" id="messageInput" placeholder="Type your message here..." />
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</main>
<script>
    console.log("chat.js loaded");

    let messageInput = document.getElementById('messageInput');
    let chatMessagesContainer = document.getElementById('chatMessagesContainer');
    let loggedInUser = document.getElementById('loggedInUser').value;
    let receiver = document.getElementById('receiver');

    function setReceiver(username) {
        receiver.value = username;
    }

    function enterMessage() {
        messageInput.addEventListener("keydown", event => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    }

    async function sendMessage() {
        console.log("sendMessage function called");

        if (messageInput.value.trim() !== '') {
            let messageContent = messageInput.value;
            let receiverValue = receiver.value;

            let response = await fetch('/Home/SendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ Receiver: receiverValue, MessageContent: messageContent })
            });

            if (response.ok) {
                let chatMessage = document.createElement('div');
                chatMessage.classList.add("chatMessage");
                chatMessage.innerHTML = `<strong>${loggedInUser}:</strong> ${messageContent}`;
                chatMessagesContainer.appendChild(chatMessage);
                messageInput.value = '';
            } else {
                alert("Failed to send message");
            }
        }
    }

    enterMessage();
</script>
</body>
